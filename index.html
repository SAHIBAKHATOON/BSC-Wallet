<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLO Ethereum</title>
    <link rel="stylesheet" href="css/main.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap"
        rel="stylesheet">
</head>

<body>
    <sm-notifications id="notification_drawer"></sm-notifications>
    <sm-popup id="confirmation_popup">
        <h4 id="confirm_title"></h4>
        <p id="confirm_message" class="breakable"></p>
        <div class="flex align-center gap-0-5 margin-left-auto">
            <button class="button cancel-button">Cancel</button>
            <button class="button button--primary confirm-button">OK</button>
        </div>
    </sm-popup>
    <main>
        <header id="main_header">
            <div id="logo" class="app-brand">
                <svg id="main_logo" class="icon" viewBox="0 0 27.25 32">
                    <title>RanchiMall</title>
                    <path
                        d="M27.14,30.86c-.74-2.48-3-4.36-8.25-6.94a20,20,0,0,1-4.2-2.49,6,6,0,0,1-1.25-1.67,4,4,0,0,1,0-2.26c.37-1.08.79-1.57,3.89-4.55a11.66,11.66,0,0,0,3.34-4.67,6.54,6.54,0,0,0,.05-2.82C20,3.6,18.58,2,16.16.49c-.89-.56-1.29-.64-1.3-.24a3,3,0,0,1-.3.72l-.3.55L13.42.94C13,.62,12.4.26,12.19.15c-.4-.2-.73-.18-.72.05a9.39,9.39,0,0,1-.61,1.33s-.14,0-.27-.13C8.76.09,8-.27,8,.23A11.73,11.73,0,0,1,6.76,2.6C4.81,5.87,2.83,7.49.77,7.49c-.89,0-.88,0-.61,1,.22.85.33.92,1.09.69A5.29,5.29,0,0,0,3,8.33c.23-.17.45-.29.49-.26a2,2,0,0,1,.22.63A1.31,1.31,0,0,0,4,9.34a5.62,5.62,0,0,0,2.27-.87L7,8l.13.55c.19.74.32.82,1,.65a7.06,7.06,0,0,0,3.46-2.47l.6-.71-.06.64c-.17,1.63-1.3,3.42-3.39,5.42L6.73,14c-3.21,3.06-3,5.59.6,8a46.77,46.77,0,0,0,4.6,2.41c.28.13,1,.52,1.59.87,3.31,2,4.95,3.92,4.95,5.93a2.49,2.49,0,0,0,.07.77h0c.09.09,0,.1.9-.14a2.61,2.61,0,0,0,.83-.32,3.69,3.69,0,0,0-.55-1.83A11.14,11.14,0,0,0,17,26.81a35.7,35.7,0,0,0-5.1-2.91C9.37,22.64,8.38,22,7.52,21.17a3.53,3.53,0,0,1-1.18-2.48c0-1.38.71-2.58,2.5-4.23,2.84-2.6,3.92-3.91,4.67-5.65a3.64,3.64,0,0,0,.42-2A3.37,3.37,0,0,0,13.61,5l-.32-.74.29-.48c.17-.27.37-.63.46-.8l.15-.3.44.64a5.92,5.92,0,0,1,1,2.81,5.86,5.86,0,0,1-.42,1.94c0,.12-.12.3-.15.4a9.49,9.49,0,0,1-.67,1.1,28,28,0,0,1-4,4.29C8.62,15.49,8.05,16.44,8,17.78a3.28,3.28,0,0,0,1.11,2.76c.95,1,2.07,1.74,5.25,3.32,3.64,1.82,5.22,2.9,6.41,4.38A4.78,4.78,0,0,1,21.94,31a3.21,3.21,0,0,0,.14.92,1.06,1.06,0,0,0,.43-.05l.83-.22.46-.12-.06-.46c-.21-1.53-1.62-3.25-3.94-4.8a37.57,37.57,0,0,0-5.22-2.82A13.36,13.36,0,0,1,11,21.19a3.36,3.36,0,0,1-.8-4.19c.41-.85.83-1.31,3.77-4.15,2.39-2.31,3.43-4.13,3.43-6a5.85,5.85,0,0,0-2.08-4.29c-.23-.21-.44-.43-.65-.65A2.5,2.5,0,0,1,15.27.69a10.6,10.6,0,0,1,2.91,2.78A4.16,4.16,0,0,1,19,6.16a4.91,4.91,0,0,1-.87,3c-.71,1.22-1.26,1.82-4.27,4.67a9.47,9.47,0,0,0-2.07,2.6,2.76,2.76,0,0,0-.33,1.54,2.76,2.76,0,0,0,.29,1.47c.57,1.21,2.23,2.55,4.65,3.73a32.41,32.41,0,0,1,5.82,3.24c2.16,1.6,3.2,3.16,3.2,4.8a1.94,1.94,0,0,0,.09.76,4.54,4.54,0,0,0,1.66-.4C27.29,31.42,27.29,31.37,27.14,30.86ZM6.1,7h0a3.77,3.77,0,0,1-1.46.45L4,7.51l.68-.83a25.09,25.09,0,0,0,3-4.82A12,12,0,0,1,8.28.76c.11-.12.77.32,1.53,1l.63.58-.57.84A10.34,10.34,0,0,1,6.1,7Zm5.71-1.78A9.77,9.77,0,0,1,9.24,7.18h0a5.25,5.25,0,0,1-1.17.28l-.58,0,.65-.78a21.29,21.29,0,0,0,2.1-3.12c.22-.41.42-.76.44-.79s.5.43.9,1.24L12,5ZM13.41,3a2.84,2.84,0,0,1-.45.64,11,11,0,0,1-.9-.91l-.84-.9.19-.45c.34-.79.39-.8,1-.31A9.4,9.4,0,0,1,13.8,2.33q-.18.34-.39.69Z" />
                </svg>
                <div class="app-name">
                    <div class="app-name__company">RanchiMall</div>
                    <h4 class="app-name__title">
                        FLO Ethereum
                    </h4>
                </div>
            </div>
            <button id="meta_mask_status_button" class="button interactive flex align-center hidden"
                data-status="disconnected" onclick="connectToMetaMask()">
                <div class="icon-wrapper">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" id="Layer_1" x="0" y="0"
                        version="1.1" viewBox="0 0 318.6 318.6">
                        <style>
                            .st1,
                            .st6 {
                                fill: #e4761b;
                                stroke: #e4761b;
                                stroke-linecap: round;
                                stroke-linejoin: round
                            }

                            .st6 {
                                fill: #f6851b;
                                stroke: #f6851b
                            }
                        </style>
                        <path fill="#e2761b" stroke="#e2761b" stroke-linecap="round" stroke-linejoin="round"
                            d="m274.1 35.5-99.5 73.9L193 65.8z" />
                        <path
                            d="m44.4 35.5 98.7 74.6-17.5-44.3zm193.9 171.3-26.5 40.6 56.7 15.6 16.3-55.3zm-204.4.9L50.1 263l56.7-15.6-26.5-40.6z"
                            class="st1" />
                        <path
                            d="m103.6 138.2-15.8 23.9 56.3 2.5-2-60.5zm111.3 0-39-34.8-1.3 61.2 56.2-2.5zM106.8 247.4l33.8-16.5-29.2-22.8zm71.1-16.5 33.9 16.5-4.7-39.3z"
                            class="st1" />
                        <path fill="#d7c1b3" stroke="#d7c1b3" stroke-linecap="round" stroke-linejoin="round"
                            d="m211.8 247.4-33.9-16.5 2.7 22.1-.3 9.3zm-105 0 31.5 14.9-.2-9.3 2.5-22.1z" />
                        <path fill="#233447" stroke="#233447" stroke-linecap="round" stroke-linejoin="round"
                            d="m138.8 193.5-28.2-8.3 19.9-9.1zm40.9 0 8.3-17.4 20 9.1z" />
                        <path fill="#cd6116" stroke="#cd6116" stroke-linecap="round" stroke-linejoin="round"
                            d="m106.8 247.4 4.8-40.6-31.3.9zM207 206.8l4.8 40.6 26.5-39.7zm23.8-44.7-56.2 2.5 5.2 28.9 8.3-17.4 20 9.1zm-120.2 23.1 20-9.1 8.2 17.4 5.3-28.9-56.3-2.5z" />
                        <path fill="#e4751f" stroke="#e4751f" stroke-linecap="round" stroke-linejoin="round"
                            d="m87.8 162.1 23.6 46-.8-22.9zm120.3 23.1-1 22.9 23.7-46zm-64-20.6-5.3 28.9 6.6 34.1 1.5-44.9zm30.5 0-2.7 18 1.2 45 6.7-34.1z" />
                        <path
                            d="m179.8 193.5-6.7 34.1 4.8 3.3 29.2-22.8 1-22.9zm-69.2-8.3.8 22.9 29.2 22.8 4.8-3.3-6.6-34.1z"
                            class="st6" />
                        <path fill="#c0ad9e" stroke="#c0ad9e" stroke-linecap="round" stroke-linejoin="round"
                            d="m180.3 262.3.3-9.3-2.5-2.2h-37.7l-2.3 2.2.2 9.3-31.5-14.9 11 9 22.3 15.5h38.3l22.4-15.5 11-9z" />
                        <path fill="#161616" stroke="#161616" stroke-linecap="round" stroke-linejoin="round"
                            d="m177.9 230.9-4.8-3.3h-27.7l-4.8 3.3-2.5 22.1 2.3-2.2h37.7l2.5 2.2z" />
                        <path fill="#763d16" stroke="#763d16" stroke-linecap="round" stroke-linejoin="round"
                            d="m278.3 114.2 8.5-40.8-12.7-37.9-96.2 71.4 37 31.3 52.3 15.3 11.6-13.5-5-3.6 8-7.3-6.2-4.8 8-6.1zM31.8 73.4l8.5 40.8-5.4 4 8 6.1-6.1 4.8 8 7.3-5 3.6 11.5 13.5 52.3-15.3 37-31.3-96.2-71.4z" />
                        <path
                            d="m267.2 153.5-52.3-15.3 15.9 23.9-23.7 46 31.2-.4h46.5zm-163.6-15.3-52.3 15.3-17.4 54.2h46.4l31.1.4-23.6-46zm71 26.4 3.3-57.7 15.2-41.1h-67.5l15 41.1 3.5 57.7 1.2 18.2.1 44.8h27.7l.2-44.8z"
                            class="st6" />
                        <script xmlns="" />
                    </svg>
                </div>
                <div id="meta_mask_status">Disconnected</div>
            </button>
            <theme-toggle></theme-toggle>
        </header>
        <aside class="flex flex-direction-column">
            <h4>
                Searched addresses
            </h4>
            <ul id="searched_addresses_list" class="grid gap-0-5"></ul>
        </aside>
        <section id="main_section" class="grid gap-1-5">
            <h2>
                Check USDC/USDT balance
            </h2>
            <sm-form oninvalid="handleInvalidSearch()">
                <div id="input_wrapper">
                    <sm-input id="private_key_input" class="password-field flex-1" placeholder="FLO/BTC private key"
                        type="password" data-private-key animate required>
                        <svg class="icon" slot="icon" xmlns="http://www.w3.org/2000/svg"
                            enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px"
                            fill="#000000">
                            <g>
                                <rect fill="none" height="24" width="24"></rect>
                            </g>
                            <g>
                                <path
                                    d="M21,10h-8.35C11.83,7.67,9.61,6,7,6c-3.31,0-6,2.69-6,6s2.69,6,6,6c2.61,0,4.83-1.67,5.65-4H13l2,2l2-2l2,2l4-4.04L21,10z M7,15c-1.65,0-3-1.35-3-3c0-1.65,1.35-3,3-3s3,1.35,3,3C10,13.65,8.65,15,7,15z">
                                </path>
                            </g>
                        </svg>
                        <label slot="right" class="interact">
                            <input type="checkbox" class="hidden" autocomplete="off" readonly=""
                                onchange="togglePrivateKeyVisibility(this)">
                            <svg class="icon invisible" xmlns="http://www.w3.org/2000/svg" height="24px"
                                viewBox="0 0 24 24" width="24px" fill="#000000">
                                <title>Hide password</title>
                                <path d="M0 0h24v24H0zm0 0h24v24H0zm0 0h24v24H0zm0 0h24v24H0z" fill="none"></path>
                                <path
                                    d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z">
                                </path>
                            </svg>
                            <svg class="icon visible" xmlns="http://www.w3.org/2000/svg" height="24px"
                                viewBox="0 0 24 24" width="24px" fill="#000000">
                                <title>Show password</title>
                                <path d="M0 0h24v24H0z" fill="none"></path>
                                <path
                                    d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z">
                                </path>
                            </svg>
                        </label>
                    </sm-input>
                    <div class="multi-state-button">
                        <button id="check_balance_button" class="button button--primary h-100 w-100" type="submit"
                            onclick="checkBalance()" disabled>Check
                            balance</button>
                    </div>
                </div>
            </sm-form>
            <div id="eth_balance_wrapper" class="grid gap-2 hidden">
                <div class="grid">
                    <div class="label">ETH address</div>
                    <sm-copy id="eth_address"></sm-copy>
                </div>
                <div class="grid">
                    <div class="label">FLO address</div>
                    <sm-copy id="flo_address"></sm-copy>
                </div>
                <div class="grid gap-1">
                    <h4>Balance</h4>
                    <ul id="eth_address_balance" class="flex flex-direction-column gap-0-5">
                        <li class="flex align-center space-between">
                            <p>USDC</p>
                            <b id="usdc_balance">0</b>
                        </li>
                        <li class="flex align-center space-between">
                            <p>USDT</p>
                            <b id="usdt_balance">0</b>
                        </li>
                    </ul>
                </div>
            </div>
        </section>
        <section id="error_section" class="hidden">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" id="Layer_1" x="0" y="0"
                version="1.1" viewBox="0 0 318.6 318.6">
                <style>
                    .st1,
                    .st6 {
                        fill: #e4761b;
                        stroke: #e4761b;
                        stroke-linecap: round;
                        stroke-linejoin: round
                    }

                    .st6 {
                        fill: #f6851b;
                        stroke: #f6851b
                    }
                </style>
                <path fill="#e2761b" stroke="#e2761b" stroke-linecap="round" stroke-linejoin="round"
                    d="m274.1 35.5-99.5 73.9L193 65.8z" />
                <path
                    d="m44.4 35.5 98.7 74.6-17.5-44.3zm193.9 171.3-26.5 40.6 56.7 15.6 16.3-55.3zm-204.4.9L50.1 263l56.7-15.6-26.5-40.6z"
                    class="st1" />
                <path
                    d="m103.6 138.2-15.8 23.9 56.3 2.5-2-60.5zm111.3 0-39-34.8-1.3 61.2 56.2-2.5zM106.8 247.4l33.8-16.5-29.2-22.8zm71.1-16.5 33.9 16.5-4.7-39.3z"
                    class="st1" />
                <path fill="#d7c1b3" stroke="#d7c1b3" stroke-linecap="round" stroke-linejoin="round"
                    d="m211.8 247.4-33.9-16.5 2.7 22.1-.3 9.3zm-105 0 31.5 14.9-.2-9.3 2.5-22.1z" />
                <path fill="#233447" stroke="#233447" stroke-linecap="round" stroke-linejoin="round"
                    d="m138.8 193.5-28.2-8.3 19.9-9.1zm40.9 0 8.3-17.4 20 9.1z" />
                <path fill="#cd6116" stroke="#cd6116" stroke-linecap="round" stroke-linejoin="round"
                    d="m106.8 247.4 4.8-40.6-31.3.9zM207 206.8l4.8 40.6 26.5-39.7zm23.8-44.7-56.2 2.5 5.2 28.9 8.3-17.4 20 9.1zm-120.2 23.1 20-9.1 8.2 17.4 5.3-28.9-56.3-2.5z" />
                <path fill="#e4751f" stroke="#e4751f" stroke-linecap="round" stroke-linejoin="round"
                    d="m87.8 162.1 23.6 46-.8-22.9zm120.3 23.1-1 22.9 23.7-46zm-64-20.6-5.3 28.9 6.6 34.1 1.5-44.9zm30.5 0-2.7 18 1.2 45 6.7-34.1z" />
                <path d="m179.8 193.5-6.7 34.1 4.8 3.3 29.2-22.8 1-22.9zm-69.2-8.3.8 22.9 29.2 22.8 4.8-3.3-6.6-34.1z"
                    class="st6" />
                <path fill="#c0ad9e" stroke="#c0ad9e" stroke-linecap="round" stroke-linejoin="round"
                    d="m180.3 262.3.3-9.3-2.5-2.2h-37.7l-2.3 2.2.2 9.3-31.5-14.9 11 9 22.3 15.5h38.3l22.4-15.5 11-9z" />
                <path fill="#161616" stroke="#161616" stroke-linecap="round" stroke-linejoin="round"
                    d="m177.9 230.9-4.8-3.3h-27.7l-4.8 3.3-2.5 22.1 2.3-2.2h37.7l2.5 2.2z" />
                <path fill="#763d16" stroke="#763d16" stroke-linecap="round" stroke-linejoin="round"
                    d="m278.3 114.2 8.5-40.8-12.7-37.9-96.2 71.4 37 31.3 52.3 15.3 11.6-13.5-5-3.6 8-7.3-6.2-4.8 8-6.1zM31.8 73.4l8.5 40.8-5.4 4 8 6.1-6.1 4.8 8 7.3-5 3.6 11.5 13.5 52.3-15.3 37-31.3-96.2-71.4z" />
                <path
                    d="m267.2 153.5-52.3-15.3 15.9 23.9-23.7 46 31.2-.4h46.5zm-163.6-15.3-52.3 15.3-17.4 54.2h46.4l31.1.4-23.6-46zm71 26.4 3.3-57.7 15.2-41.1h-67.5l15 41.1 3.5 57.7 1.2 18.2.1 44.8h27.7l.2-44.8z"
                    class="st6" />
                <script xmlns="" />
            </svg>
            <h2 id="error__title">
                MetaMask not installed
            </h2>
            <p>
                Please install MetaMask browser extension to use this app
            </p>
        </section>
    </main>
    <script src="https://unpkg.com/uhtml@3.0.1/es.js"></script>
    <script src="scripts/components.min.js" type="text/javascript"></script>
    <script src="scripts/btcwallet_scripts_lib.js" type="text/javascript"></script>
    <script src="scripts/btcOperator.js" type="text/javascript"></script>
    <script src="scripts/floCrypto.js" type="text/javascript"></script>
    <script src="scripts/tap_combined.js" type="text/javascript"></script>
    <script src="scripts/keccak.js" type="text/javascript"></script>
    <script src="scripts/floEthereum.js" type="text/javascript"></script>
    <script src="scripts/compactIDB.js" type="text/javascript"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js" type="text/javascript"> </script>
    <script src="scripts/usdc_balance.js" type="text/javascript"> </script>
    <script>
        const uiGlobals = {}
        const { html, svg, render: renderElem } = uhtml;
        uiGlobals.connectionErrorNotification = []
        //Checks for internet connection status
        if (!navigator.onLine)
            uiGlobals.connectionErrorNotification.push(notify('There seems to be a problem connecting to the internet, Please check you internet connection.', 'error'))
        window.addEventListener('offline', () => {
            uiGlobals.connectionErrorNotification.push(notify('There seems to be a problem connecting to the internet, Please check you internet connection.', 'error'))
        })
        window.addEventListener('online', () => {
            uiGlobals.connectionErrorNotification.forEach(notification => {
                getRef('notification_drawer').remove(notification)
            })
            notify('We are back online.', 'success')
        })
        // Use instead of document.getElementById
        function getRef(elementId) {
            return document.getElementById(elementId)
        }
        let zIndex = 50
        // function required for popups or modals to appear
        function openPopup(popupId, pinned) {
            zIndex++
            getRef(popupId).setAttribute('style', `z-index: ${zIndex}`)
            getRef(popupId).show({ pinned })
            return getRef(popupId);
        }

        // hides the popup or modal
        function closePopup() {
            if (popupStack.peek() === undefined)
                return;
            popupStack.peek().popup.hide()
        }

        document.addEventListener('popupopened', async e => {
            switch (e.target.id) {
                case 'saved_ids_popup':
                    const allSavedIds = await getArrayOfSavedIds()
                    const renderedIds = renderContactPickerList(allSavedIds)
                    renderElem(getRef('saved_ids_picker_list'), html`${renderedIds}`)
                    getRef('search_saved_ids_picker').focusIn()
                    break;
            }
        })
        document.addEventListener('popupclosed', e => {
            zIndex--
            switch (e.target.id) {
                case 'saved_ids_popup':
                    renderElem(getRef('saved_ids_picker_list'), html``)
                    getRef('search_saved_ids_picker').value = ''
                    floGlobals.addressSelectorTarget = null
                    break;
                case 'transaction_result_popup':
                    renderElem(getRef('transaction_result'), html``)
                    break;
                case 'retrieve_flo_id_popup':
                    getRef('recovered_flo_id_wrapper').classList.add('hidden')
                    break;
            }
        })
        //Function for displaying toast notifications. pass in error for mode param if you want to show an error.
        function notify(message, mode, options = {}) {
            let icon
            switch (mode) {
                case 'success':
                    icon = `<svg class="icon icon--success" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z"/></svg>`
                    break;
                case 'error':
                    icon = `<svg class="icon icon--error" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1-7v2h2v-2h-2zm0-8v6h2V7h-2z"/></svg>`
                    options.pinned = true
                    break;
            }
            if (mode === 'error') {
                console.error(message)
            }
            return getRef("notification_drawer").push(message, { icon, ...options });
        }
        // displays a popup for asking permission. Use this instead of JS confirm
        const getConfirmation = (title, options = {}) => {
            return new Promise(resolve => {
                const { message = '', cancelText = 'Cancel', confirmText = 'OK', danger = false } = options
                openPopup('confirmation_popup', true)
                getRef('confirm_title').innerText = title;
                getRef('confirm_message').innerText = message;
                const cancelButton = getRef('confirmation_popup').querySelector('.cancel-button');
                const confirmButton = getRef('confirmation_popup').querySelector('.confirm-button')
                confirmButton.textContent = confirmText
                cancelButton.textContent = cancelText
                if (danger)
                    confirmButton.classList.add('button--danger')
                else
                    confirmButton.classList.remove('button--danger')
                confirmButton.onclick = () => {
                    closePopup()
                    resolve(true);
                }
                cancelButton.onclick = () => {
                    closePopup()
                    resolve(false);
                }
            })
        }
        function createRipple(event, target) {
            const circle = document.createElement("span");
            const diameter = Math.max(target.clientWidth, target.clientHeight);
            const radius = diameter / 2;
            const targetDimensions = target.getBoundingClientRect();
            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - (targetDimensions.left + radius)}px`;
            circle.style.top = `${event.clientY - (targetDimensions.top + radius)}px`;
            circle.classList.add("ripple");
            const rippleAnimation = circle.animate(
                [
                    {
                        opacity: 1,
                        transform: `scale(0)`
                    },
                    {
                        transform: "scale(4)",
                        opacity: 0,
                    },
                ],
                {
                    duration: 600,
                    fill: "forwards",
                    easing: "ease-out",
                }
            );
            target.append(circle);
            rippleAnimation.onfinish = () => {
                circle.remove();
            };
        }
        function buttonLoader(id, show) {
            const button = typeof id === 'string' ? document.getElementById(id) : id;
            if (!button) return
            if (!button.dataset.hasOwnProperty('wasDisabled'))
                button.dataset.wasDisabled = button.disabled
            const animOptions = {
                duration: 200,
                fill: 'forwards',
                easing: 'ease'
            }
            if (show) {
                button.disabled = true
                button.parentNode.append(document.createElement('sm-spinner'))
                button.animate([
                    {
                        clipPath: 'circle(100%)',
                    },
                    {
                        clipPath: 'circle(0)',
                    },
                ], animOptions)
            } else {
                button.disabled = button.dataset.wasDisabled === 'true';
                button.animate([
                    {
                        clipPath: 'circle(0)',
                    },
                    {
                        clipPath: 'circle(100%)',
                    },
                ], animOptions).onfinish = (e) => {
                    button.removeAttribute('data-original-state')
                }
                const potentialTarget = button.parentNode.querySelector('sm-spinner')
                if (potentialTarget) potentialTarget.remove();
            }
        }
    </script>
    <script>
        window.smCompConfig = {
            'sm-input': [
                {
                    selector: '[data-btc-address]',
                    customValidation: (value) => {
                        if (!value) return { isValid: false, errorText: 'Please enter a BTC address' }
                        return {
                            isValid: btcOperator.validateAddress(value),
                            errorText: `Invalid address.<br> It usually starts with "1", "3" or "bc1."`
                        }
                    }
                },
                {
                    selector: '[data-private-key]',
                    customValidation: (value) => {
                        if (!value) return { isValid: false, errorText: 'Please enter a private key' }
                        return {
                            isValid: floCrypto.getPubKeyHex(value),
                            errorText: `Invalid private key.<br> It usually starts with "L" or "R".`
                        }
                    }
                }
            ]
        }
        function setMetaMaskStatus(isConnected) {
            if (isConnected) {
                getRef('meta_mask_status').textContent = 'Connected';
                getRef('meta_mask_status_button').dataset.status = 'connected';
            } else {
                getRef('meta_mask_status').textContent = 'Disconnected';
                getRef('meta_mask_status_button').dataset.status = 'disconnected';
            }

        }
        window.addEventListener('load', () => {
            document.body.classList.remove('hidden')
            document.addEventListener('keyup', (e) => {
                if (e.key === 'Escape') {
                    closePopup()
                }
            })
            document.addEventListener('copy', () => {
                notify('copied', 'success')
            })
            document.addEventListener("pointerdown", (e) => {
                if (e.target.closest("button:not(:disabled), .interactive:not(:disabled)")) {
                    createRipple(e, e.target.closest("button, .interactive"));
                }
            });
            compactIDB.initDB('floEthereum', {
                contacts: {}
            }).then((result) => {
                renderSearchedAddressList()
            }).catch((error) => {
                console.error(error)
            })
            connectToMetaMask().then(() => {
                // setMetaMaskStatus(window.ethereum.isConnected())
                window.ethereum.on('chainChanged', (networkId) => {
                    if (networkId !== '1') {
                        getRef('error__title').textContent = 'Please switch MetaMask to Ethereum Mainnet'
                        getRef('main_section').classList.add('hidden')
                        getRef('error_section').classList.remove('hidden')
                    } else {
                        getRef('main_section').classList.remove('hidden')
                        getRef('error_section').classList.add('hidden')
                    }
                })
                window.ethereum.request({
                    "method": "eth_chainId"
                }).then(chainId => {
                    if (chainId !== '0x1') {
                        getRef('error__title').textContent = 'Please switch MetaMask to Ethereum Mainnet'
                        getRef('main_section').classList.add('hidden')
                        getRef('error_section').classList.remove('hidden')
                    } else {
                        getRef('main_section').classList.remove('hidden')
                        getRef('error_section').classList.add('hidden')
                    }
                })
            }).catch((error) => {
                setMetaMaskStatus(false)
                if (error.code === 4001) {
                    // EIP-1193 userRejectedRequest error
                    notify('Please connect to MetaMask to continue', 'error')
                } else {
                    if (error === 'MetaMask not installed') {
                        getRef('main_section').classList.add('hidden')
                        getRef('error_section').classList.remove('hidden')
                    }
                    else
                        console.error(error)
                }
            })
            if (typeof window.ethereum !== 'undefined') {
                ethereum.on('accountsChanged', (accounts) => {
                    getRef('eth_balance_wrapper').classList.add('hidden')
                    setMetaMaskStatus(accounts.length > 0)
                });
                ethereum.on('connect', (accounts) => {
                    setMetaMaskStatus(accounts.length > 0)
                });
                ethereum.on('disconnect', (accounts) => {
                    setMetaMaskStatus(false)
                });
            }
        })
        function renderSearchedAddressList() {
            compactIDB.readAllData('contacts').then(contacts => {
                if (Object.keys(contacts).length === 0) {
                    renderElem(getRef('searched_addresses_list'), html`<li class="flex align-center justify-center">
                        <p>Your searched addresses will appear here for easier access in future.</p>    
                    </li>`)
                    return
                }
                const renderedContacts = []
                for (const floAddress in contacts) {
                    const { ethAddress } = contacts[floAddress]
                    renderedContacts.push(html`
                        <li class="contact" .dataset=${{ floAddress, ethAddress }}>
                            <sm-chips onchange=${e => e.target.closest('.contact').querySelector('sm-copy').value = e.target.value}>
                                <sm-chip value=${floAddress} selected>FLO</sm-chip>
                                <sm-chip value=${ethAddress}>ETH</sm-chip>
                            </sm-chips>
                            <sm-copy value="${floAddress}"></sm-copy>
                            <div class="flex align-center space-between gap-0-5">
                                <button class="button button--small" onclick=${() => deleteContact(floAddress)}>
                                    Delete
                                </button>
                                <button class="button button--colored button--small" onclick=${() => checkBalance(ethAddress, floAddress)}>Check balance</button>
                            </div>
                        </li>`)
                }
                renderElem(getRef('searched_addresses_list'), html`${renderedContacts}`)
            }).catch((error) => {
                console.error(error)
            })
        }
        function checkBalance(ethAddress, floAddress) {
            if (!ethAddress) {
                const keyToConvert = document.querySelector('[data-private-key]').value.trim()
                if (/^[0-9a-fA-F]{64}$/.test(keyToConvert)) {
                    keyToConvert = coinjs.privkey2wif(keyToConvert)
                }
                const ethPrivateKey = coinjs.wif2privkey(keyToConvert).privkey;
                ethAddress = floEthereum.ethAddressFromPrivateKey(ethPrivateKey)
                floAddress = floCrypto.getFloID(keyToConvert)
            }
            if (!ethAddress) return
            buttonLoader('check_balance_button', true)
            Promise.all([checkUSDCBalance(ethAddress), checkUSDTBalance(ethAddress)]).then(([usdcBalance, usdtBalance]) => {
                compactIDB.readData('contacts', floAddress).then(result => {
                    if (result) return
                    compactIDB.addData('contacts', {
                        ethAddress,
                    }, floAddress).then(() => {
                        renderSearchedAddressList()
                    }).catch((error) => {
                        console.error(error)
                    })
                })
                getRef('eth_address').value = ethAddress
                getRef('flo_address').value = floAddress
                getRef('usdc_balance').textContent = `${ethers.utils.formatUnits(usdcBalance, 6)} USDC`
                getRef('usdt_balance').textContent = `${ethers.utils.formatUnits(usdtBalance, 6)} USDT`
                getRef('eth_balance_wrapper').classList.remove('hidden')
                getRef('eth_balance_wrapper').animate([
                    {
                        transform: 'translateY(-1rem)',
                        opacity: 0
                    },
                    {
                        transform: 'none',
                        opacity: 1
                    }
                ], {
                    easing: 'ease',
                    duration: 300,
                    fill: 'forwards'
                })
            }).catch((error) => {
                notify(error, 'error')
            }).finally(() => {
                buttonLoader('check_balance_button', false)
            })
        }
        function handleInvalidSearch() {
            if (document.startViewTransition)
                document.startViewTransition(() => {
                    getRef('eth_balance_wrapper').classList.add('hidden')
                })
            else {
                getRef('eth_balance_wrapper').classList.add('hidden')
            }

        }
        async function deleteContact(floAddress) {
            const confirmed = await getConfirmation('Delete contact', {
                message: 'Are you sure you want to delete this contact?'
            })
            if (!confirmed) return
            compactIDB.removeData('contacts', floAddress).then(() => {
                renderSearchedAddressList()
            }).catch((error) => {
                console.error(error)
            })
        }
    </script>
</body>

</html>